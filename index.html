<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <h1 class="text-center">Chromatic Staff</h1>
        <div class="col-xs-12">
            <label id="chromatic"></label>
            <pre id="chromatic-staff"></pre>
        </div>
    </div>
    <div class="row">
        <h1 id="selection" class="text-center">
            <select id="key"></select>
            <select id="interval"></select>
        </h1>
        <div class="col-xs-6">
            <legend class="text-center">Scale</legend>
            <label id="scale"></label>
            <pre id="scale-staff"></pre>
        </div>
        <div class="col-xs-6">
            <legend class="text-center">Triad</legend>
            <label id="triad"></label>
            <pre id="triad-staff"></pre>
        </div>
    </div>
    <legend class="text-center">Tabs</legend>
    <div class="row">
        <div class="col-xs-6">
            <pre id="scale-tab"></pre>
        </div>
        <div class="col-xs-6">
            <pre id="triad-tab"></pre>
        </div>
    </div>
</div>
<script>
    Array.prototype.chunk = function (size = 1, fill = false) {
        const tmp = [];
        do {
            const chunk = this.splice(0, size);
            if (fill && chunk.length < size) {
                chunk.splice(chunk.length, size - chunk.length, null);
            }
            tmp.push(chunk);
        } while (this.length);
        return tmp;
    };

    Array.prototype.flatten = function () {
        return this.reduce((acc, e) => acc.concat(e instanceof Array ? e : [e]), []);
    };

    const CHROMATIC = [' C  ', ' C# ', ' D  ', ' D# ', ' E  ', ' F  ', ' F# ', ' G  ', ' G# ', ' A  ', ' A# ', ' B  '];
    const INTERVALS = {
        Major: [0, 2, 2, 2, 1, 2, 2],
        Minor: [0, 2, 1, 2, 2, 1, 2],
    };

    const keyInput = document.getElementById('key');
    const intervalInput = document.getElementById('interval');

    class Renderer {
        static draw(note) {
            if (note instanceof Array) return note.map(n => CHROMATIC[n % CHROMATIC.length]);
            if (typeof note === 'number') return CHROMATIC[note % CHROMATIC.length];
            if (undefined === note) {
                throw Error('Bad note');
            }
            return note;
        }

        static drawStaff(notes) {
            if (!notes) return;

            notes = (notes instanceof Array ? notes : [notes]).map(Music.findNote);
            return [[5, 6], [7, 8], [9, 10], [11], [0, 1], [2, 3], [4]]
                .reverse()
                .map((g, i) => {
                    const line = CHROMATIC[g[0]].trim() + notes
                        .map(n => g.includes(n % CHROMATIC.length) ? this.draw(n) : '    ')
                        .chunk(4, true)
                        .map(g => ['|'].concat(g.map(s => s === null ? '    ' : s))).flatten()
                        .join('') + '||';
                    return i % 2 ? line.replace(/ /g, '-') : line;
                })
                .join("\n");
        }

        static drawTab(notes) {
            if (!notes) return;

            notes = (notes instanceof Array ? notes : [notes]).map(Music.findNote);
            const ROOTS = [4, 9, 2, 7, 11, 4];
            return ROOTS
                .map(root => [0, 1, 2, 3, 4].map(add => (root + add) % CHROMATIC.length))
                .reverse()
                .map(g => CHROMATIC[g[0]].trim() + notes
                    .map(n => ('---' + (g.includes(n) ? (n + CHROMATIC.length - g[0]) % CHROMATIC.length : '')).slice(-3))
                    .chunk(4, true)
                    .map(g => ['|'].concat(g.map(t => t === null ? '---' : t))).flatten()
                    .join('') + '||')
                .join("\n");
        }

        static spellOut(notes) {
            return notes.map((n, i) => `(${i}) ${this.draw(n).trim()}`).join(', ')
        }

        static render() {
            const key = parseInt(keyInput.options[keyInput.selectedIndex].value);
            const interval = intervalInput.options[intervalInput.selectedIndex].value;
            const scale = Music.makeScale(key, INTERVALS[interval]);
            const triad = Music.makeTriad(key, INTERVALS[interval]);
            document.getElementById('scale').innerHTML = Renderer.spellOut(scale);
            document.getElementById('scale-staff').innerHTML = Renderer.drawStaff(scale);
            document.getElementById('scale-tab').innerHTML = Renderer.drawTab(scale);
            document.getElementById('triad').innerHTML = Renderer.spellOut(triad);
            document.getElementById('triad-staff').innerHTML = Renderer.drawStaff(triad);
            document.getElementById('triad-tab').innerHTML = Renderer.drawTab(triad);
        }
    }

    class Music {
        static findNote(note = 0) {
            return typeof note === 'string' ? CHROMATIC.indexOf(note) : note;
        }

        static makeScale(note = 0, interval = INTERVALS.Major) {
            note = this.findNote(note);
            return interval.map(i => note += i);
        }

        static makeTriad(note = 0, interval = INTERVALS.Major) {
            const scale = this.makeScale(note, interval);
            return [0, 2, 4].map(i => scale[i]);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        keyInput.addEventListener('change', Renderer.render);
        intervalInput.addEventListener('change', Renderer.render);
        CHROMATIC.forEach((s, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.text = s.trim();
            keyInput.appendChild(option);
        });
        for (let interval in INTERVALS) {
            const option = document.createElement('option');
            option.value = interval;
            option.text = interval;
            intervalInput.appendChild(option);
        }
        document.getElementById('chromatic').innerHTML = Renderer.spellOut(CHROMATIC);
        document.getElementById('chromatic-staff').innerHTML = Renderer.drawStaff(CHROMATIC);
        Renderer.render();
    });
</script>
</body>
</html>
