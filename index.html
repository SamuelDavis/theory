<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <h1 class="text-center">Chromatic Staff</h1>
        <div class="col-sm-12">
            <label id="chromatic"></label>
            <pre id="chromatic-staff"></pre>
        </div>
    </div>
    <div class="row">
        <h1 class="text-center"><select id="string"></select> Staff
            <button class="btn btn-primary" id="string-challenge">Challenge</button>
        </h1>
        <div class="col-sm-12">
            <label id="per-string"></label>
            <pre id="per-string-staff"></pre>
        </div>
    </div>
    <div class="row">
        <h1 id="selection" class="text-center">
            <select id="key"></select>
            <select id="interval"></select>
        </h1>
        <div class="col-sm-6">
            <legend class="text-center">Scale</legend>
            <label id="scale"></label>
            <pre id="scale-staff"></pre>
        </div>
        <div class="col-sm-6">
            <legend class="text-center">Triad</legend>
            <label id="triad"></label>
            <pre id="triad-staff"></pre>
        </div>
    </div>
    <legend class="text-center">Tabs</legend>
    <div class="row">
        <div class="col-sm-6">
            <pre id="scale-tab"></pre>
        </div>
        <div class="col-sm-6">
            <pre id="triad-tab"></pre>
        </div>
    </div>
    <div class="modal" id="string-challenge-target">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" id="string-challenge-dismiss">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-6">
                            <pre id="string-challenge-note"></pre>
                        </div>
                        <div class="col-xs-6">
                            <pre id="string-challenge-tab"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
    Array.prototype.chunk = function (size = 1, fill = false) {
        const tmp = [];
        do {
            const chunk = this.splice(0, size);
            if (fill && chunk.length < size) {
                chunk.splice(chunk.length, size - chunk.length, null);
            }
            tmp.push(chunk);
        } while (this.length);
        return tmp;
    };

    Array.prototype.flatten = function () {
        return this.reduce((acc, e) => acc.concat(e instanceof Array ? e : [e]), []);
    };

    const CHROMATIC = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const INTERVALS = {
        Major: [0, 2, 2, 2, 1, 2, 2],
        Minor: [0, 2, 1, 2, 2, 1, 2],
    };

    const TUNING = {
        classic: [4, 9, 2, 7, 11, 4],
    };

    const keyInput = document.getElementById('key');
    const intervalInput = document.getElementById('interval');
    const stringInput = document.getElementById('string');
    const stringChallenge = document.getElementById('string-challenge');
    const stringChallengeModal = document.getElementById('string-challenge-target');
    const stringChallengeDismiss = document.getElementById('string-challenge-dismiss');
    let stringChallengeInterval = null;
    const stringChallengeNote = document.getElementById('string-challenge-note');
    const stringChallengeTab = document.getElementById('string-challenge-tab');

    class Renderer {
        static draw(note) {
            if (note instanceof Array) return note.map(n => CHROMATIC[n % CHROMATIC.length]);
            if (typeof note === 'number') return CHROMATIC[note % CHROMATIC.length];
            if (undefined === note) {
                throw Error('Bad note');
            }
            return note;
        }

        static drawStaff(notes) {
            if (!notes) return;

            notes = (notes instanceof Array ? notes : [notes]).map(Music.findNote);
            return [[5, 6], [7, 8], [9, 10], [11], [0, 1], [2, 3], [4]]
                .reverse()
                .map((g, i) => {
                    const line = CHROMATIC[g[0]].trim() + notes
                        .map(n => g.includes(n % CHROMATIC.length) ? (' ' + this.draw(n) + '  ').substr(-4) : '    ')
                        .chunk(4, true)
                        .map(g => ['|'].concat(g.map(s => s === null ? '    ' : s))).flatten()
                        .join('') + '||';
                    return i % 2 ? line.replace(/ /g, '-') : line;
                })
                .join("\n");
        }

        static drawTab(notes, roots = TUNING.classic, tabsPerString = 5) {
            if (!notes) return;

            tabsPerString = new Array(tabsPerString)
                .fill(undefined)
                .map((_, i) => i);

            notes = (notes instanceof Array ? notes : [notes]).map(Music.findNote);
            return roots
                .map(root => tabsPerString.map(add => (root + add) % CHROMATIC.length))
                .reverse()
                .map(g => CHROMATIC[g[0]].trim() + notes
                    .map(n => n % CHROMATIC.length)
                    .map(n => g.includes(n) ? (n + CHROMATIC.length - g[0]) % CHROMATIC.length : '')
                    .map(n => ('---' + n).substr(-3))
                    .chunk(4, true)
                    .map(g => ['|'].concat(g.map(t => t === null ? '---' : t))).flatten()
                    .join('') + '||')
                .join("\n");
        }

        static spellOut(notes) {
            return notes.map((n, i) => `(${n}) ${this.draw(n).trim()}`).join(', ')
        }

        static render() {
            const key = parseInt(keyInput.options[keyInput.selectedIndex].value);
            const interval = intervalInput.options[intervalInput.selectedIndex].value;
            const scale = Music.makeScale(key, INTERVALS[interval]);
            const triad = Music.makeTriad(key, INTERVALS[interval]);
            const string = parseInt(stringInput.options[stringInput.selectedIndex].value);
            document.getElementById('scale').innerHTML = Renderer.spellOut(scale);
            document.getElementById('per-string-staff').innerHTML = Renderer.drawTab(CHROMATIC, [string], CHROMATIC.length);
            document.getElementById('scale-staff').innerHTML = Renderer.drawStaff(scale);
            document.getElementById('scale-tab').innerHTML = Renderer.drawTab(scale);
            document.getElementById('triad').innerHTML = Renderer.spellOut(triad);
            document.getElementById('triad-staff').innerHTML = Renderer.drawStaff(triad);
            document.getElementById('triad-tab').innerHTML = Renderer.drawTab(triad);
        }
    }

    class Music {
        static findNote(note = 0) {
            return typeof note === 'string' ? CHROMATIC.indexOf(note) : note;
        }

        static makeScale(note = 0, interval = INTERVALS.Major) {
            note = this.findNote(note);
            return interval.map(i => note += i);
        }

        static makeTriad(note = 0, interval = INTERVALS.Major) {
            const scale = this.makeScale(note, interval);
            return [0, 2, 4].map(i => scale[i]);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        keyInput.addEventListener('change', Renderer.render);
        intervalInput.addEventListener('change', Renderer.render);
        stringInput.addEventListener('change', Renderer.render);
        stringChallenge.addEventListener('click', function () {
            stringChallengeModal.classList.add('show');
            stringChallengeInterval = setInterval(function () {
                const note = CHROMATIC[Math.floor(Math.random() * CHROMATIC.length)];
                const string = parseInt(stringInput.options[stringInput.selectedIndex].value);
                stringChallengeNote.innerHTML = Renderer.drawStaff(note);
                stringChallengeTab.innerHTML = Renderer.drawTab(note, [string], CHROMATIC.length)
            }, 1000);
        });
        stringChallengeDismiss.addEventListener('click', function () {
            clearInterval(stringChallengeInterval);
            stringChallengeModal.classList.remove('show');
        });

        TUNING.classic.forEach(root => {
            const option = document.createElement('option');
            option.value = root;
            option.text = Renderer.draw(root);
            stringInput.appendChild(option);
        });

        CHROMATIC.forEach((s, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.text = s.trim();
            keyInput.appendChild(option);
        });
        for (let interval in INTERVALS) {
            const option = document.createElement('option');
            option.value = interval;
            option.text = interval;
            intervalInput.appendChild(option);
        }

        document.getElementById('chromatic').innerHTML = Renderer.spellOut(Object.keys(CHROMATIC).map(n => parseInt(n)));
        document.getElementById('chromatic-staff').innerHTML = Renderer.drawStaff(CHROMATIC);
        Renderer.render();
    });
</script>
</body>
</html>
